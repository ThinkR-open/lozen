---
title: "af - Deploy a pkgdown on Posit Connect and Gitlab Pages through GitLab CI/CD"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{af-deploy-a-pkgdown-on-connect-through-gitlab-ci}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(lozen)
```

For the following to be working, please ensure you are working in a valid R package. Your project must be associated with a repository present on Gitlab.

If this is not done yet please go to the vignette `vignettes/aa-create-a-new-project-with-gitlab.Rmd` and follow theses sections:

- Define the name of the principal branch
- Connection to GitLab
- Create a new project or use an existing project
- Clone your project and add the skeleton for your product (package, app, bookdown)
  + Create the skeleton for your product and initiate the CI/CD
    + R package skeleton

Before running the following commands please ensure that you are working on your R package project.

For this toy example, we are filling our empty package (we don't have any function in the `R/` directory) using {fusen}

# Add a function with its documentation and test

```{r, eval=FALSE}
dev_file <- suppressMessages(fusen::add_minimal_package(pkg = ".", overwrite = TRUE, open = FALSE))
flat_file <- dev_file[grepl("flat_", dev_file)]
fusen::inflate(
  pkg = ".",
  flat_file = flat_file,
  vignette_name = "Minimal",
  open_vignette = FALSE,
  check = FALSE,
  quiet = TRUE
)
```

# Create the pkgdown

```{r, eval=FALSE}
usethis::use_pkgdown()
pkgdown::build_site(override = list(destination = "inst/site"))
```

# Initiate the deployment of your pkgdown

## To be done on your R project

```{r, eval=FALSE}
lozen::use_gitlab_ci_deploy_connect_pkgdown()
```

The `.gitlab-ci.yml` file, which was already present in your project is you followed the process described in the vignette `vignettes/aa-create-a-new-project-with-gitlab.Rmd`, is now completed with new staged, specific to the deployment on Connect.

## To be done on Gitlab

Some environment variables must be set on Gitlab for the CI/CD to be working.

You'll need to define : 

```{r, eval=FALSE}
CONNECT_URL <- "https://my.connect.url"
CONNECT_NAME <- "my.connect.server.name"
CONNECT_USER <- "my.connect.username"
CONNECT_TOKEN <- "my.api.key.generated.in.connect"
APP_NAME <- "the.name.of.your.pkgdown.on.connect"
GITHUB_PAT <- "my.personal.access.token.generated.in.github"
```

For most of them, you may have already set them on your `.Renviron` file (see the dedicated section on the {lozen} README).

If you are not familiar with defining environement variable on gitlab, please follow the [official documentation](https://docs.gitlab.com/ee/ci/variables/index.html).

Once this is done, you can commit all your changes and push them to your repository remote.

Thereafter, you should be able to [see your pipeline running](https://docs.gitlab.com/ee/ci/pipelines/#view-pipelines) on Gitlab.

# How can I find the pkgdown associated with my R package on Gitlab Pages

If your pipeline did not raise any error, the deployed pkgdown is now hosted on [Gitlab pages](https://docs.gitlab.com/ee/user/project/pages/getting_started_part_one.html).

If you are working on `https://gitlab.com`, the pkgdown url should be `https://username.gitlab.io/your.repository.name`. 


# How can I find the pkgdown associated with my R package on Posit Connect

If your pipeline did not raise any error, you app is now deployed on your Posit Connect. You can now log in your Posit Connect and enjoy your pkgdown !
