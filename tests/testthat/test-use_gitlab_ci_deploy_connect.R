# WARNING - Generated by {fusen} from dev/flat_use_gitlab_ci_deploy_connect.Rmd: do not edit by hand

test_that("use_gitlab_ci_deploy_connect works", {
  expect_true(inherits(use_gitlab_ci_deploy_connect, "function"))
})

test_that("use_gitlab_ci_deploy_connect_shiny works", {
  expect_true(inherits(use_gitlab_ci_deploy_connect_shiny, "function"))

  # TODO - Remove ; allow test to pass on CI
  skip_on_ci()

  # Test on Gitlab : Create a golem and test the CI

  # Pour un template CI "golem"


  if (Sys.getenv("ALLOW_CI_TESTS_ON_GITLAB", unset = "FALSE") == "TRUE") {
    output_golem <- with_gitlab_project(
      gitlab_url = Sys.getenv("GITLAB_URL", unset = "https://gitlab.com"),
      namespace_id = NULL,
      private_token = Sys.getenv("GITLAB_TOKEN"),
      project_name = "golem.test.project",
      exp = {
        lozen::create_r_project(project_path = getwd(), type = "golem", name_licence = "test", type_licence = usethis::use_mit_license)
        golem::add_rstudioconnect_file(open = FALSE)
        lozen::use_gitlab_ci(type = "check-coverage-pkgdown")
        lozen::use_gitlab_ci_deploy_connect_shiny(append = TRUE)
      }
    )

    expect_equal(
      object = output_golem$status,
      expected = "success"
    )

    expect_equal(
      object = output_golem$connect,
      expected = 200
    )
  }
  if (Sys.getenv("ALLOW_CI_TESTS_ON_GITLAB", unset = "FALSE") == "TRUE") {
    # Pour un template CI "golem"
    output_shiny <- with_gitlab_project(
      gitlab_url = Sys.getenv("GITLAB_URL", unset = "https://gitlab.com"),
      namespace_id = NULL,
      private_token = Sys.getenv("GITLAB_TOKEN"),
      project_name = "shinytestproject",
      exp = {
        cat(
          'library(shiny);

            ui <- fluidPage(
                  h1("Coucou"));

            server <- function(input, output, session) {
            }
            shinyApp(ui, server)',
          file = "app.R"
        )

        # shiny::shinyAppTemplate(path = ".",
        #                  examples = "app",
        #                  dryrun = FALSE)
        # lozen::use_gitlab_ci(type = "check-coverage-pkgdown")
        lozen::use_gitlab_ci_deploy_connect_shiny()
      }
    )

    expect_equal(
      object = output_shiny$status,
      expected = "success"
    )

    expect_equal(
      object = output_shiny$connect,
      expected = 200
    )
  }
})

test_that("use_gitlab_ci_deploy_connect_pkgdown works", {
  expect_true(inherits(use_gitlab_ci_deploy_connect_pkgdown, "function"))

  # TODO - Remove ; allow test to pass on CI
  skip_on_ci()

  # Test on Gitlab : Create a golem and test the CI

  # Pour un template CI "golem"


  if (Sys.getenv("ALLOW_CI_TESTS_ON_GITLAB", unset = "FALSE") == "TRUE") {
    output_pkgdown <- with_gitlab_project(
      gitlab_url = Sys.getenv("GITLAB_URL", unset = "https://gitlab.com"),
      namespace_id = NULL,
      private_token = Sys.getenv("GITLAB_TOKEN"),
      project_name = "pkgdown.test.project",
      exp = {
        lozen::create_r_project(type = "package", project_path = getwd(), name_licence = "test", type_licence = usethis::use_mit_license)
        unlink(x = "_pkgdown.yml", force = TRUE)
        withr::with_dir(getwd(), {
          attachment::att_amend_desc(extra.suggests = c("pkgdown"))
          desc_to_pimp <- desc::desc("DESCRIPTION")
          attachment::set_remotes_to_desc()
          desc_to_pimp$write()
          usethis::use_r("dummy")
          pkgdown::build_site(override = list(destination = "inst/site")) # non ce n'est pas ce qu'il faut deployer
        })

        lozen::use_gitlab_ci(type = "check-coverage-pkgdown")
        lozen::use_gitlab_ci_deploy_connect_pkgdown(append = TRUE)
      }
    )

    expect_equal(
      object = output_pkgdown$status,
      expected = "success"
    )

    expect_equal(
      object = output_pkgdown$connect,
      expected = 200
    )
  }
})
