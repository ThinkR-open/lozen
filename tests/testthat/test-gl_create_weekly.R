# WARNING - Generated by {fusen} from /dev/flat_create_weekly.Rmd: do not edit by hand

## 04-05-2023 On skip pour des raisons d'auth sur le CI
skip_on_ci()

test_that("gl_create_weekly works", {
  expect_true(inherits(gl_create_weekly, "function"))
  
  gitlab_url <-
    Sys.getenv("GITLAB_URL", unset = "https://gitlab.com")
  
  the_token <- Sys.getenv("GITLAB_TOKEN")
  
  # GitLab con
  my_gitlab <- gl_connection(gitlab_url = gitlab_url,
                             private_token = the_token)
  
  # Set the connection for the session
  set_gitlab_connection(my_gitlab)
  
  # Get user infos
  user_info <- gitlab(req = paste0("user"), verb = httr::GET)
  user_name <- user_info %>% pull(username)
  
  project_name <- "lozenexempleissues"
  
  # Get user namespace (= group_id)
  # namespace_id <- gitlabr::gitlab(req = "namespaces", search = user_name)[["id"]]
  group_url <- user_info[["web_url"]]
  
  
  # create_group_project ----
  project_id <-
    create_group_project(project_name, namespace_id = NULL)
  
  add_board(
    project_id,
    labels_order = c(
      "Blocked",
      "Ready",
      "In progress",
      "Review",
      "Pre-validation",
      "Validation"
    ),
    lg = "en"
  )
  
  yesterday <- lubridate::today() - 1
  
  ### Open ans close issues for weekly
  url <- paste0("/projects/", project_id, "/", "issues")
  
  ### List of issues
  issues_need <- list(
    test1 = list(created_at = yesterday,
                 label = "Ready"),
    test2 = list(created_at = yesterday,
                 label = "In progress"),
    test3 = list(created_at = yesterday,
                 label = "Blocked"),
    test4 = list(created_at = yesterday,
                 label = "Review"),
    test5 = list(created_at = yesterday,
                 label = "Validation"),
    test6 = list(created_at = yesterday,
                 label = "Ready")
  )
  # Open issues
  purrr::iwalk(issues_need, ~ {
    gitlab(
      url,
      title = .y,
      verb = httr::POST,
      created_at = as.character(.x[["created_at"]]),
      labels = .x[["label"]]
    )
  })
  
  # Close an issue
  gitlabr::gl_close_issue(project = project_id,
                          issue_id = 6,
                          labels = "")
  
  weekly_en <- gl_create_weekly(
    project_id = project_id,
    language = "en",
    date_min = yesterday,
    date_max = lubridate::today(),
    private_token = Sys.getenv("GITLAB_TOKEN")
  )
  
  info_en <- weekly_en$weekly_info
  
  
  expect_length(info_en, 1)
  expect_true(grepl(":white_check_mark: Realised", info_en))
  expect_true(grepl(":octagonal_sign: Blocked", info_en))
  expect_true(grepl(":thumbsup: Realised and to validate", info_en))
  expect_true(grepl(":notepad_spiral: In progress", info_en))
  expect_true(grepl(":thumbsup: Ready", info_en))
  expect_true(grepl(":seedling: New issues opened", info_en))
  
  expect_equal(
    weekly_en$weekly_issues$info,
    c(
      "1todelete - :white_check_mark: Realised and validated",
      "2todelete - :octagonal_sign: Blocked",
      "3todelete - :thumbsup: Realised and to validate",
      "4todelete - :notepad_spiral: In progress",
      "4todelete - :notepad_spiral: In progress",
      "5todelete - :thumbsup: Ready",
      "9todelete - :seedling: New issues opened",
      "9todelete - :seedling: New issues opened",
      "9todelete - :seedling: New issues opened",
      "9todelete - :seedling: New issues opened",
      "9todelete - :seedling: New issues opened",
      "9todelete - :seedling: New issues opened"
    )
  )
  
  # EN DAILY
  daily_en <- gl_create_weekly(
    project_id = project_id,
    language = "en",
    date_min = yesterday,
    date_max = lubridate::today(),
    private_token = Sys.getenv("GITLAB_TOKEN"),
    daily = TRUE
  )
  
  info_en <- daily_en$weekly_info
  
  expect_length(info_en, 1)
  expect_true(grepl(":date: The next date", info_en))
  expect_true(grepl(":book: As a reminder, links to the previous Weekly:", info_en))
  
  # FR WEEKLY
  weekly_fr <- gl_create_weekly(
    project_id = project_id,
    language = "fr",
    date_min = yesterday,
    date_max = lubridate::today(),
    private_token = Sys.getenv("GITLAB_TOKEN")
  )
  info_fr <- weekly_fr$weekly_info
  
  expect_length(info_fr, 1)
  expect_true(grepl(":white_check_mark: R\u00e9alis\u00e9", info_fr))
  expect_true(grepl(":octagonal_sign: Bloqu\u00e9", info_fr))
  expect_true(grepl(":thumbsup: R\u00e9alis\u00e9 et \u00e0 valider", info_fr))
  expect_true(grepl(":notepad_spiral: En cours", info_fr))
  expect_true(grepl(":thumbsup: R\u00e9alis\u00e9 et \u00e0 valider", info_fr))
  expect_true(grepl(":thumbsup: Pr\u00eat", info_fr))
  
  expect_equal(
    weekly_fr$weekly_issues$info,
    c(
      "1todelete - :white_check_mark: Réalisé et validé",
      "2todelete - :octagonal_sign: Bloqué",
      "3todelete - :thumbsup: Réalisé et à valider",
      "4todelete - :notepad_spiral: En cours",
      "4todelete - :notepad_spiral: En cours",
      "5todelete - :thumbsup: Prêt",
      "9todelete - :seedling: Nouvelles issues ouvertes",
      "9todelete - :seedling: Nouvelles issues ouvertes",
      "9todelete - :seedling: Nouvelles issues ouvertes",
      "9todelete - :seedling: Nouvelles issues ouvertes",
      "9todelete - :seedling: Nouvelles issues ouvertes",
      "9todelete - :seedling: Nouvelles issues ouvertes"
    )
  )
  
  # FR DAILY
  daily_fr <- gl_create_daily(
    project_id = project_id,
    language = "fr",
    date_daily = yesterday,
    private_token = Sys.getenv("GITLAB_TOKEN")
  )
  
  info_daily_fr <- daily_fr$weekly_info
  
  expect_length(info_daily_fr, 1)
  expect_true(grepl(":date: La prochaine date", info_daily_fr))
  expect_true(grepl(
    ":book: Pour rappel, lien vers le Weekly pr\u00e9c\u00e9dent :",
    info_daily_fr
  ))
  
  # we need yesterday and group_url to get daily
  expect_equal(object = info_daily_fr,
               expected = glue::glue("## Daily - {yesterday}\n\n\n _Note for the Lead Dev: Some sections were automatically created. This is the case for the section :warning: and the section :soon:. In the section :warning:, please delete the not-appropriate issues, or write a specific text. In the section :soon:, please arrange the issues according to the priority. Also, you must complete the next date for the mission. => DELETE THIS PARAGRAPH_\n\n\n :heavy_check_mark: Tout frais fait du jour et à valider\n\n- test5: [issue 5]({group_url}/lozenexempleissues/-/issues/5) - Not assigned\n\n\n:heavy_check_mark: Tout frais fait du jour et validé\n\n- test6: [issue 6 (closed)]({group_url}/lozenexempleissues/-/issues/6) - Not assigned\n\n\n:memo: En cours, à garder au chaud pour la prochaine fois\n\n- test2: [issue 2]({group_url}/lozenexempleissues/-/issues/2) - Not assigned\n- test4: [issue 4]({group_url}/lozenexempleissues/-/issues/4) - Not assigned\n\n\n:warning: Ça commence à être compliqué par ici, on va devoir ré-ajuster les priorités ou les besoins\n\n\n\n- test2: [issue 2]({group_url}/lozenexempleissues/-/issues/2) - Not assigned\n- test4: [issue 4]({group_url}/lozenexempleissues/-/issues/4) - Not assigned\n\n\n:octagonal_sign: Bloqué, besoin de votre retour\n\n- test3: [issue 3]({group_url}/lozenexempleissues/-/issues/3) - Not assigned\n\n\n:soon: Les prochains sur la liste\n\n- test1: [issue 1]({group_url}/lozenexempleissues/-/issues/1) - Not assigned\n\n\n:seedling: Les nouveaux tickets du jour\n\n- test1: [issue 1]({group_url}/lozenexempleissues/-/issues/1) - Not assigned\n- test2: [issue 2]({group_url}/lozenexempleissues/-/issues/2) - Not assigned\n- test3: [issue 3]({group_url}/lozenexempleissues/-/issues/3) - Not assigned\n- test4: [issue 4]({group_url}/lozenexempleissues/-/issues/4) - Not assigned\n- test5: [issue 5]({group_url}/lozenexempleissues/-/issues/5) - Not assigned\n- test6: [issue 6 (closed)]({group_url}/lozenexempleissues/-/issues/6) - Not assigned\n\n\n:date: La prochaine date : (A remplir)\n\n\n:book: Pour rappel, lien vers le Weekly précédent : {group_url}/lozenexempleissues/-/wikis/Weekly")
               )
  
  # Clean GitLab => Remove the project
  gitlabr::gitlab(req = paste0("projects/", project_id),
                  verb = httr::DELETE)
  
  
})

test_that("gl_create_weekly works checks the max_page", {
  # EN WEEKLY
    expect_error(
      object = gl_create_weekly(
        project_id = 123456789,
        language = "en",
        date_min = "2022-07-04",
        date_max = "2022-07-20",
        private_token = Sys.getenv("GITLAB_TOKEN"),
        max_page_opened = NA
      ), regexp = "max_page_opened should be upper or equal to 1"
    )
    
    expect_error(
      object = gl_create_weekly(
        project_id = 123456789,
        language = "en",
        date_min = "2022-07-04",
        date_max = "2022-07-20",
        private_token = Sys.getenv("GITLAB_TOKEN"),
        max_page_opened = 11,
        max_page_closed = -5
      ), regexp = "max_page_closed should be upper or equal to 1"
    )
})
